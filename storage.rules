rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // User Avatars: users/{userId}/avatars/*
    // Allow anyone to read avatars
    // Allow only the owner to upload/delete their own avatar
    match /users/{userId}/avatars/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // User Photos/Projects: users/{userId}/photos/*
    // Allow anyone to read photos (assuming they are public posts)
    // Allow only the owner to upload/delete their own photos
    match /users/{userId}/photos/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Gallery: gallery/{albumId}/{fileName}
    // Allow anyone to read gallery images
    // Ideally, only admins should write here. 
    // Since we can't easily check admin role in Storage rules without Custom Claims,
    // we restrict to authenticated users for now.
    // TODO: Implement Custom Claims for robust Admin checks in Storage.
    match /gallery/{allPaths=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Fallback for other paths (e.g. if we add new features)
    // Default to authenticated write, public read if needed, or deny.
    // For now, we'll keep it restrictive by default for unknown paths.
    match /{allPaths=**} {
      allow read: if true;
      allow write: if isAuthenticated(); 
    }
  }
}
